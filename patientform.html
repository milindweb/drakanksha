<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Form - NAD Patient Management</title>
  <link rel="stylesheet" href="css/headerfooter.css">
  <script src="js/headerfooter.js" defer></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f5f7fa; }
    .section { background:#fff; margin:10px auto; border-radius:10px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); width:95%; max-width:1200px; }
    .section h3 { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .section h3 span { font-size:0.8em; color:#007bff; }
    .form-row { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .form-group { flex:1 1 200px; display:flex; flex-direction:column; }
    label { font-size:0.9em; font-weight:600; color:#444; margin-bottom:3px; }
    input, select, textarea { padding:8px; border:1px solid #ccc; border-radius:5px; font-size:0.9em; }
    textarea { resize:vertical; min-height:40px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    table th, table td { border:1px solid #ddd; padding:6px; font-size:0.9em; }
    table th { background:#e9ecef; }
    button { background:#007bff; color:white; border:none; padding:8px 14px; border-radius:5px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .hidden { display:none; }
  </style>
</head>

<body>
  <div id="header"></div>

  <div class="section" id="basic-info">
    <h3 onclick="toggleSection('basic-body')">Basic Info <span>Show/Hide</span></h3>
    <div id="basic-body">
      <div class="form-row">
        <div class="form-group"><label>Date</label><input type="text" id="date"></div>
        <div class="form-group"><label>OPD No</label><input type="text" id="opd"></div>
        <div class="form-group"><label>Patient Name</label><input type="text" id="pname"></div>
        <div class="form-group"><label>Mobile No.</label><input type="text" id="mobile"></div>
        <div class="form-group"><label>Gender</label>
          <select id="gender"><option>Male</option><option>Female</option><option>Other</option></select>
        </div>
        <div class="form-group"><label>Age</label><input type="number" id="age"></div>
        <div class="form-group"><label>Department</label>
          <select id="dept"><option>General</option><option>Gynaecology</option></select>
        </div>
        <div class="form-group"><label>Doctor</label><select id="doctor"></select></div>
      </div>
    </div>
  </div>

  <div class="section" id="clinical">
    <h3 onclick="toggleSection('clinical-body')">Clinical Info <span>Show/Hide</span></h3>
    <div id="clinical-body">
      <div class="form-row">
        <div class="form-group"><label>Chief Complaint</label><select id="chief"></select></div>
        <div class="form-group"><label>Sub-Symptoms</label><select id="subsym"></select></div>
        <div class="form-group"><label>Specific Complaint</label><textarea id="specific"></textarea></div>
      </div>
    </div>
  </div>

  <div class="section" id="vitals">
    <h3 onclick="toggleSection('vitals-body')">Vitals <span>Show/Hide</span></h3>
    <div id="vitals-body">
      <div class="form-row">
        <div class="form-group"><label>Weight (kg)</label><input id="weight" type="number"><small>Normal: 50–80</small></div>
        <div class="form-group"><label>BP</label><input id="bp" type="text"><small>Normal: 120/80</small></div>
        <div class="form-group"><label>Pulse</label><input id="pulse" type="number"><small>Normal: 60–100</small></div>
        <div class="form-group"><label>Temp (°F)</label><input id="temp" type="number"><small>Normal: 97–99</small></div>
        <div class="form-group"><label>Sugar</label><input id="sugar" type="number"><small>Normal: 70–120</small></div>
      </div>
    </div>
  </div>

  <div class="section" id="investigations">
    <h3 onclick="toggleSection('invest-body')">Investigations <span>Show/Hide</span></h3>
    <div id="invest-body">
      <div class="form-row">
        <input placeholder="Test Category" id="testcat" list="catList">
        <datalist id="catList"></datalist>
        <input placeholder="Test Name" id="testname" list="testList">
        <datalist id="testList"></datalist>
        <input placeholder="Reports" id="reports">
        <input placeholder="Normal Range / Limit" id="range" readonly>
        <input placeholder="Dr.Remark" id="drremark">
        <button onclick="addInvestigation()">Add</button>
      </div>
      <table id="investTable"><thead><tr><th>Category</th><th>Name</th><th>Report</th><th>Limit</th><th>Remark</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="section" id="treatment">
    <h3 onclick="toggleSection('treat-body')">Treatment <span>Show/Hide</span></h3>
    <div id="treat-body">
      <div class="form-group"><label>Diagnosis</label><textarea id="diagnosis"></textarea></div>
      <div class="form-row">
        <input placeholder="Form (Tablet/Syrup/Injection)" id="formavail" list="formList">
        <datalist id="formList"></datalist>
        <input placeholder="Generic / API / Brand" id="generic" list="medList">
        <datalist id="medList"></datalist>
        <input placeholder="Comment" id="comment">
        <button onclick="addPrescription()">Add</button>
      </div>
      <table id="rxTable"><thead><tr><th>Form</th><th>Medicine</th><th>Comment</th></tr></thead><tbody></tbody></table>
      <div class="form-group"><label>Advice</label><textarea id="advice"></textarea></div>
      <div class="form-group"><label>Effect After Treatment</label>
        <select id="effect"><option>Improved</option><option>No Change</option><option>Worse</option></select>
      </div>
      <div class="form-group"><label>Dr. Note / Remarks</label><textarea id="remarks"></textarea></div>
    </div>
  </div>

  <div class="section">
    <div class="form-row" style="justify-content:space-between;">
      <button onclick="previewData()">Preview</button>
      <button onclick="submitForm()">Submit</button>
    </div>
  </div>

  <div id="footer"></div>

 <script>
const APP_URL = "https://script.google.com/macros/s/AKfycbysvWwETA5lDzsx6_zi8yPEWFTY05fxNFIUiDIZZ0VvrvwzyefX1WtEcfFTkohdJDqi/exec";

let investigations = [];
let prescriptions = [];

// -------------------- Helper Functions --------------------
function toggleSection(id) {
  const el = document.getElementById(id);
  el.classList.toggle("hidden");
}

function val(id) { return document.getElementById(id).value.trim(); }
function clear(ids) { ids.forEach(i => document.getElementById(i).value = ""); }

function generateOPD() {
  const now = new Date();
  return `${now.getFullYear().toString().slice(2)}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
}

async function loadJSON(path) {
  const res = await fetch(path);
  return await res.json();
}

// -------------------- Initial Load --------------------
document.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("date").value = new Date().toLocaleDateString('en-GB');
  document.getElementById("opd").value = generateOPD();

  await Promise.all([
    loadDoctors(),
    loadComplaints(),
    loadLabTests(),
    loadMedicines()
  ]);
});

// -------------------- Load Doctors --------------------
async function loadDoctors() {
  const data = await loadJSON("data/drname.json");
  const sel = document.getElementById("doctor");
  data.doctors.forEach(name => {
    const opt = document.createElement("option");
    opt.textContent = name;
    sel.appendChild(opt);
  });
}

// -------------------- Load Complaints --------------------
async function loadComplaints() {
  const data = await loadJSON("data/complaint.json");
  const chiefSel = document.getElementById("chief");
  const subSel = document.getElementById("subsym");

  data.forEach(item => {
    const opt = document.createElement("option");
    opt.textContent = item.chiefComplaint;
    chiefSel.appendChild(opt);
  });

  chiefSel.addEventListener("change", () => {
    subSel.innerHTML = "";
    const found = data.find(c => c.chiefComplaint === chiefSel.value);
    if (found && found.subSymptoms) {
      found.subSymptoms.forEach(sub => {
        const o = document.createElement("option");
        o.textContent = sub;
        subSel.appendChild(o);
      });
    }
  });
}

// -------------------- Load Lab Tests --------------------
let labData = [];
async function loadLabTests() {
  const data = await loadJSON("data/labtest.json");
  labData = data.laboratoryTests || [];
  const catList = document.getElementById("catList");

  labData.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat.category;
    catList.appendChild(opt);
  });

  // On category change, populate test names
  document.getElementById("testcat").addEventListener("input", e => {
    const testList = document.getElementById("testList");
    testList.innerHTML = "";
    const cat = labData.find(c => c.category === e.target.value);
    if (cat) {
      cat.tests.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.testName;
        testList.appendChild(opt);
      });
    }
  });

  // On test name change, show normal range
  document.getElementById("testname").addEventListener("input", e => {
    const cat = labData.find(c => c.category === document.getElementById("testcat").value);
    if (cat) {
      const test = cat.tests.find(t => t.testName === e.target.value);
      if (test) document.getElementById("range").value = test.normalRange;
    }
  });
}

// -------------------- Load Medicines --------------------
async function loadMedicines() {
  const data = await loadJSON("data/medlist.json");
  const medList = document.getElementById("medList");
  const formList = document.getElementById("formList");
  const forms = new Set();

  data.forEach(m => {
    const genericName = m["Generic "][" API (Single or Combination)"];
    const brandNames = m["Common Brand Names (India)"];
    const opt = document.createElement("option");
    opt.value = `${genericName} (${brandNames})`;
    medList.appendChild(opt);

    if (m["Forms Available"]) {
      m["Forms Available"].split(",").forEach(f => forms.add(f.trim()));
    }
  });

  forms.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f;
    formList.appendChild(opt);
  });
}

// -------------------- Investigation & Prescription --------------------
function addInvestigation() {
  const t = [val("testcat"), val("testname"), val("reports"), val("range"), val("drremark")];
  if (!t[1]) return alert("Enter test name");
  investigations.push(t);
  renderTable("investTable", investigations);
  clear(["testcat","testname","reports","range","drremark"]);
}

function addPrescription() {
  const t = [val("formavail"), val("generic"), val("comment")];
  if (!t[1]) return alert("Enter medicine name");
  prescriptions.push(t);
  renderTable("rxTable", prescriptions);
  clear(["formavail","generic","comment"]);
}

function renderTable(id, data) {
  const tbody = document.querySelector(`#${id} tbody`);
  tbody.innerHTML = "";
  data.forEach(r => {
    const tr = document.createElement("tr");
    r.forEach(c => {
      const td = document.createElement("td");
      td.textContent = c;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

// -------------------- Collect and Submit --------------------
function collectFormData() {
  return {
    date: val("date"),
    opd: val("opd"),
    patientName: val("pname"),
    mobile: val("mobile"),
    gender: val("gender"),
    age: val("age"),
    department: val("dept"),
    doctor: val("doctor"),
    chiefComplaint: val("chief"),
    subSymptoms: val("subsym"),
    specificComplaint: val("specific"),
    weight: val("weight"),
    bp: val("bp"),
    pulse: val("pulse"),
    temp: val("temp"),
    sugar: val("sugar"),
    investigations,
    prescriptions,
    diagnosis: val("diagnosis"),
    advice: val("advice"),
    effect: val("effect"),
    drRemarks: val("remarks")
  };
}

function submitForm() {
  const data = collectFormData();
  if (!data.patientName) { alert("Enter patient name"); return; }

  fetch(APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "save", data })
  })
  .then(r => r.json())
  .then(res => {
    if (res.success) {
      alert("Data Saved Successfully!");
      location.reload();
    } else alert("Error: " + res.message);
  })
  .catch(err => alert("Error: " + err));
}
</script>

</body>
</html>


