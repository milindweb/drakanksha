<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Profile â€” Tabs (View & Edit)</title>

  <!-- Keep your header/footer loader + global header/footer CSS -->
  <link rel="stylesheet" href="css/headerfooter.css">
  <script src="js/headerfooter.js" defer></script>

  <!-- ===== Page-specific styles (scoped, won't touch other pages) ===== -->
  <style>
    /* ---------------- Global layout (scoped to this page) ---------------- */
    :root {
      --page-max-width: 1000px;
      --accent: #2563eb;
      --muted: #64748b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
    }
    .pp-container {
      max-width: var(--page-max-width);
      margin: 18px auto 60px;
      padding: 0 16px;
      box-sizing: border-box;
      font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
      color: #0f172a;
    }

    /* ---------------- Page title ---------------- */
    .pp-title {
      text-align: center;
      margin: 18px 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    /* ---------------- Search + suggestions ---------------- */
    .pp-search {
      display: flex;
      justify-content: center;
      margin: 8px 0 16px;
    }
    .pp-search input[type="search"] {
      width: 100%;
      max-width: 560px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 1rem;
      background: white;
      box-shadow: 0 1px 3px rgba(16,24,40,0.04);
    }
    .pp-suggestions {
      max-width: 560px;
      margin: 6px auto 0;
      display: none;
      background: var(--card-bg);
      border: 1px solid #e6eef8;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.06);
      overflow: auto;
      max-height: 220px;
      z-index: 1500;
    }
    .pp-suggestion {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.95rem;
    }
    .pp-suggestion:last-child { border-bottom: none; }
    .pp-suggestion:hover { background: #f1f5f9; }

    /* ---------------- Card & header ---------------- */
    .pp-card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.06);
      overflow: hidden;
    }
    .pp-card-header {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      background: #eef2ff;
    }
    .pp-avatar {
      width: 84px;
      height: 84px;
      border-radius: 50%;
      background: #e2e8f0 url('https://i.ibb.co/sK7PjGf/profile-avatar.png') center/cover no-repeat;
      border: 3px solid #334155;
      flex: 0 0 84px;
    }
    .pp-header-meta h3 {
      margin: 0 0 6px;
      font-size: 1.15rem;
    }
    .pp-header-meta p { margin: 0; color: var(--muted); font-size: 0.95rem; }

    /* ---------------- Tabs ---------------- */
    .pp-tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #eef2ff;
      padding: 8px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0));
      flex-wrap: wrap;
    }
    .pp-tab {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
      color: #0f172a;
      font-weight: 600;
      transition: all 0.18s ease;
      font-size: 0.95rem;
      border: 2px solid transparent;
    }
    .pp-tab:hover { transform: translateY(-2px); }
    .pp-tab.active {
      background: white;
      border-color: var(--accent);
      box-shadow: 0 6px 18px rgba(37,99,235,0.08);
      color: var(--accent);
    }

    /* ---------------- Tab content ---------------- */
    .pp-tab-panel {
      padding: 16px;
      display: none;
    }
    .pp-tab-panel.active { display: block; }

    /* ----- Profile info grid ----- */
    .pp-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    .pp-field {
      background: #fbfdff;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #eef2ff;
    }
    .pp-field label { display:block; font-size:0.82rem; color:var(--muted); margin-bottom:6px; }
    .pp-field .value { font-weight:600; font-size:0.98rem; }

    /* ----- Visit History table ----- */
    .pp-table-wrap { overflow-x: auto; margin-top: 10px; }
    table.pp-table {
      width:100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 780px;
    }
    table.pp-table th, table.pp-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #eef2ff;
      text-align: left;
      vertical-align: middle;
    }
    table.pp-table thead th {
      background: #f8fafc;
      font-weight:600;
      color: #0f172a;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    td .cell-value { display:inline-block; }
    td .edit-icon { margin-left:8px; cursor:pointer; color:var(--accent); font-size:14px; }

    td[contenteditable="true"] { background: #fff8dc; outline: none; }

    /* ----- Prescriptions & Tests compact ----- */
    .pp-list { display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .pp-list .pill {
      background:#fbfdff; padding:10px 12px; border-radius:8px; border:1px solid #eef2ff;
    }

    /* ----- Update area ----- */
    .pp-actions { display:flex; gap:12px; justify-content:flex-end; padding:16px; border-top:1px solid #f1f5f9; background: #ffffff; }
    .pp-btn {
      background: var(--accent);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight:600;
      transition: background 0.16s;
    }
    .pp-btn:active { transform: translateY(1px); }
    .pp-btn.secondary {
      background: #f3f4f6; color: #0f172a; border: 1px solid #e6eef8;
    }

    /* ----- Toast ----- */
    .pp-toast {
      position: fixed;
      right: 18px;
      top: 18px;
      background: #16a34a; color: white;
      padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 20px rgba(2,6,23,0.16);
      opacity: 0; transform: translateY(-8px); transition: all 0.28s;
      z-index: 3000;
    }
    .pp-toast.show { opacity: 1; transform: translateY(0); }

    /* ---------------- Responsive tweaks ---------------- */
    @media (max-width: 820px) {
      .pp-grid { grid-template-columns: 1fr; }
      table.pp-table { min-width: 640px; }
    }
    @media (max-width: 520px) {
      .pp-card-header { gap: 10px; padding: 12px; }
      .pp-avatar { width: 70px; height: 70px; }
      .pp-tabs { padding: 8px 10px; gap: 6px; }
      table.pp-table { min-width: 520px; font-size: 0.92rem; }
    }
  </style>
</head>

<body>

  <!-- DYNAMIC HEADER (loaded by your headerfooter.js) -->
  <div id="header"></div>

  <!-- ===== Page container ===== -->
  <main class="pp-container" id="pp-root">

    <h1 class="pp-title">ðŸ”Ž Patient â€” Profile & Visits</h1>

    <!-- ===== Search area ===== -->
    <div class="pp-search" aria-label="Search patient">
      <input id="pp-search" type="search" placeholder="Search by name, OPD no, or mobile..." aria-label="search" />
    </div>

    <div class="pp-suggestions" id="pp-suggestions" role="listbox" aria-label="Suggestions"></div>

    <!-- ===== Card (Profile + Tabs) ===== -->
    <div class="pp-card" id="pp-card" style="display:none;">

      <!-- Card header (avatar + brief meta) -->
      <div class="pp-card-header" id="pp-card-header">
        <div class="pp-avatar" id="pp-avatar" aria-hidden="true"></div>
        <div class="pp-header-meta">
          <h3 id="pp-name">Name</h3>
          <p id="pp-meta">OPD: <span id="pp-opd"></span> â€¢ Mobile: <span id="pp-mobile"></span></p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="pp-tabs" role="tablist" aria-label="Patient sections">
        <button class="pp-tab active" data-tab="profile" role="tab">Profile Info</button>
        <button class="pp-tab" data-tab="history" role="tab">Visit History</button>
        <button class="pp-tab" data-tab="rx" role="tab">Prescriptions & Tests</button>
      </div>

      <!-- Tab panels -->
      <!-- PROFILE INFO -->
      <section class="pp-tab-panel active" id="tab-profile" role="tabpanel">
        <div class="pp-tab-body">
          <div class="pp-grid" id="pp-info-grid">
            <!-- Fields will be inserted here dynamically -->
          </div>
        </div>
      </section>

      <!-- VISIT HISTORY (editable rows) -->
      <section class="pp-tab-panel" id="tab-history" role="tabpanel">
        <div class="pp-tab-body">
          <div class="pp-table-wrap">
            <table class="pp-table" id="pp-history-table" aria-describedby="Visit history">
              <thead><tr id="pp-thead"></tr></thead>
              <tbody id="pp-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRESCRIPTIONS & TESTS -->
      <section class="pp-tab-panel" id="tab-rx" role="tabpanel">
        <div class="pp-tab-body">
          <div class="pp-list" id="pp-rx-list"></div>
        </div>
      </section>

      <!-- Actions -->
      <div class="pp-actions">
        <button class="pp-btn secondary" id="pp-cancel">Close</button>
        <button class="pp-btn" id="pp-save">UPDATE SELECTED PATIENT</button>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="pp-toast" id="pp-toast" role="status" aria-live="polite">Saved</div>

  <!-- DYNAMIC FOOTER -->
  <div id="footer"></div>

  <!-- ===== Page scripts (search, tabs, edit, update) ===== -->
  <script>
  /*************************************************************************
   * Patient Profile (Tabbed) â€” Frontend
   * - Works with your existing Apps Script endpoint (updatePatient action)
   * - Loads all patients via GET ?action=read
   * - Shows suggestions, selected patient card with tabs
   * - Visit History table is editable (double-click or edit icon)
   * - UPDATE sends only selected patient rows (filteredPatients)
   *
   * NOTE: This script assumes header/footer are loaded separately by your
   * headerfooter.js (the same loader you already use).
   *************************************************************************/

  // ----------------- Config -----------------
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgRNLtac8jSFw8a9DTAwHaHMx8kgu4Ba7JhpTUgee1WfOK00zYIJ-zQIgG0TY1UuY37A/exec";

  // ----------------- State -----------------
  let allPatients = [];        // all rows from sheet (array of objects)
  let filteredPatients = [];   // currently selected patient's rows (array)
  let currentPatientKey = null; // canonical key used for matching (lowercased patientName + opd if available)

  // ----------------- DOM refs -----------------
  const searchEl = document.getElementById('pp-search');
  const suggEl = document.getElementById('pp-suggestions');
  const cardEl = document.getElementById('pp-card');
  const nameEl = document.getElementById('pp-name');
  const opdEl = document.getElementById('pp-opd');
  const mobileEl = document.getElementById('pp-mobile');
  const infoGrid = document.getElementById('pp-info-grid');
  const thead = document.getElementById('pp-thead');
  const tbody = document.getElementById('pp-tbody');
  const rxList = document.getElementById('pp-rx-list');
  const toast = document.getElementById('pp-toast');
  const saveBtn = document.getElementById('pp-save');
  const cancelBtn = document.getElementById('pp-cancel');

  // Tab buttons
  const tabs = Array.from(document.querySelectorAll('.pp-tab'));
  const panels = Array.from(document.querySelectorAll('.pp-tab-panel'));

  // ----------------- Utility functions -----------------
  function showToast(msg = "Saved", timeout = 2500) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), timeout);
  }

  function safeLower(v){ return (v || "").toString().trim().toLowerCase(); }

  // ----------------- Fetch all patients from Apps Script -----------------
  async function loadAllPatients() {
    try {
      const res = await fetch(SCRIPT_URL + "?action=read");
      allPatients = await res.json();
      // ensure we have array
      if (!Array.isArray(allPatients)) allPatients = [];
      // console.log("Loaded", allPatients.length);
    } catch (err) {
      console.error("Failed to fetch patients:", err);
      allPatients = [];
    }
  }

  // Immediately load
  loadAllPatients();

  // ----------------- Search & suggestions -----------------
  let suggTimeout = null;
  searchEl.addEventListener('input', (e) => {
    const q = safeLower(e.target.value);
    clearTimeout(suggTimeout);
    if (!q) { suggEl.style.display = 'none'; return; }

    // small debounce for large sheets
    suggTimeout = setTimeout(() => {
      const matches = allPatients.filter(row =>
        (safeLower(row.patientName).includes(q)) ||
        (safeLower(row.opdNo).includes(q)) ||
        (safeLower(row.mobileNo).includes(q))
      );

      renderSuggestions(matches.slice(0, 12));
    }, 120);
  });

  function renderSuggestions(list) {
    suggEl.innerHTML = '';
    if (!list.length) { suggEl.style.display = 'none'; return; }
    list.forEach(row => {
      const div = document.createElement('div');
      div.className = 'pp-suggestion';
      div.textContent = `${row.patientName || 'â€”'}  â€¢  ${row.opdNo || 'No OPD'}  â€¢  ${row.mobileNo || ''}`;
      div.addEventListener('click', () => selectPatient(row));
      suggEl.appendChild(div);
    });
    suggEl.style.display = 'block';
  }

  // hide suggestions when clicking outside
  document.addEventListener('click', (ev) => {
    if (!suggEl.contains(ev.target) && ev.target !== searchEl) suggEl.style.display = 'none';
  });

  // ----------------- Select patient -----------------
  function selectPatient(row) {
    // compute a stable matching key (name + opd) lowercase
    currentPatientKey = safeLower(row.patientName) + "||" + safeLower(row.opdNo);
    // filter all rows that match this patient (by name + opd)
    filteredPatients = allPatients.filter(r =>
      (safeLower(r.patientName) + "||" + safeLower(r.opdNo)) === currentPatientKey
    );

    // show card and update header meta
    cardEl.style.display = 'block';
    nameEl.textContent = row.patientName || 'â€”';
    opdEl.textContent = row.opdNo || 'â€”';
    mobileEl.textContent = row.mobileNo || 'â€”';
    searchEl.value = row.patientName || '';

    // render tabs content
    renderProfileInfo(filteredPatients[0] || {});
    renderHistoryTable(filteredPatients);
    renderRxList(filteredPatients);

    // hide suggestions after select
    suggEl.style.display = 'none';
  }

  // ----------------- Render Profile Info (Profile tab) -----------------
  function renderProfileInfo(sampleRow) {
    // Decide which fields to show as "basic" profile
    const preferred = ['patientName','opdNo','mobileNo','gender','age','doctorName','department'];
    const keys = [];

    preferred.forEach(k => { if (k in sampleRow) keys.push(k); });

    // if nothing found, fallback to first 6 keys in the row
    if (!keys.length) {
      Object.keys(sampleRow).slice(0,6).forEach(k => keys.push(k));
    }

    infoGrid.innerHTML = '';
    keys.forEach(k => {
      const field = document.createElement('div');
      field.className = 'pp-field';
      field.innerHTML = `<label>${k}</label><div class="value">${sampleRow[k] || ''}</div>`;
      infoGrid.appendChild(field);
    });
  }

  // ----------------- Render Visit History Table (editable) -----------------
  function renderHistoryTable(rows) {
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (!rows || !rows.length) {
      thead.innerHTML = '<th>No data</th>';
      return;
    }

    // Use the keys from the first row as table columns (preserve order)
    const keys = Object.keys(rows[0]);

    // Build header
    keys.forEach(k => {
      const th = document.createElement('th');
      th.textContent = k;
      thead.appendChild(th);
    });

    // Build body rows
    rows.forEach((r, rowIndex) => {
      const tr = document.createElement('tr');

      keys.forEach(key => {
        const td = document.createElement('td');

        // cell value container (so edit icon doesn't get mixed in)
        const span = document.createElement('span');
        span.className = 'cell-value';
        span.textContent = r[key] || '';
        td.appendChild(span);

        // edit icon
        const edit = document.createElement('span');
        edit.className = 'edit-icon';
        edit.title = 'Edit';
        edit.innerHTML = 'âœï¸';
        edit.addEventListener('click', () => makeCellEditable(span, rowIndex, key));
        td.appendChild(edit);

        // double-click to edit too
        span.addEventListener('dblclick', () => makeCellEditable(span, rowIndex, key));

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  }

  // Make a specific cell editable (span element), and update filteredPatients on blur
  function makeCellEditable(spanEl, rowIndex, fieldKey) {
    // create a temporary editable element to avoid moving the edit icon
    const input = document.createElement('div');
    input.contentEditable = "true";
    input.className = 'cell-edit';
    input.style.minWidth = '40px';
    input.style.outline = 'none';
    input.style.display = 'inline-block';
    input.style.padding = '2px 4px';
    input.style.background = '#fff8dc';
    input.innerText = spanEl.textContent || '';

    // replace span content visually with input
    spanEl.style.display = 'none';
    spanEl.parentNode.insertBefore(input, spanEl);

    // focus and set caret to end
    input.focus();
    document.execCommand('selectAll', false, null);
    placeCaretAtEnd(input);

    // when blur or Enter pressed, save value back
    function commit() {
      const newVal = input.innerText.trim();
      // update DOM
      spanEl.textContent = newVal;
      spanEl.style.display = '';
      input.remove();

      // update state
      if (filteredPatients[rowIndex]) {
        filteredPatients[rowIndex][fieldKey] = newVal;
      }
    }

    input.addEventListener('blur', commit, { once: true });

    input.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        input.blur(); // triggers commit
      } else if (ev.key === 'Escape') {
        // cancel edit
        input.remove();
        spanEl.style.display = '';
      }
    });
  }

  // helper to set caret to end for contentEditable
  function placeCaretAtEnd(el) {
    try {
      const range = document.createRange();
      const sel = window.getSelection();
      range.selectNodeContents(el);
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);
    } catch (e) { /* ignore */ }
  }

  // ----------------- Render Prescriptions & Tests tab -----------------
  // This extracts commonly used columns like prescription, testReports, testDetails
  function renderRxList(rows) {
    rxList.innerHTML = '';
    if (!rows || !rows.length) {
      rxList.innerHTML = '<div class="pill">No prescriptions or test details found.</div>';
      return;
    }

    rows.forEach((r, idx) => {
      const pill = document.createElement('div');
      pill.className = 'pill';
      const when = r['date'] || r['Date'] || r['visitDate'] || '';
      const rx = r['prescription'] || r['Prescription'] || r['prescribed'] || '';
      const tests = r['testReports'] || r['testDetails'] || r['Test Details'] || '';

      pill.innerHTML = `<div style="font-weight:600">${when ? when + ' â€¢ ' : ''}Visit ${idx+1}</div>
                        <div style="margin-top:6px"><strong>Prescription:</strong> ${rx || 'â€”'}</div>
                        <div style="margin-top:6px"><strong>Tests/Reports:</strong> ${tests || 'â€”'}</div>`;
      rxList.appendChild(pill);
    });
  }

  // ----------------- Tabs behaviour -----------------
  tabs.forEach(t => t.addEventListener('click', () => {
    const tabName = t.getAttribute('data-tab');

    // mark active
    tabs.forEach(x => x.classList.toggle('active', x === t));
    panels.forEach(p => p.classList.toggle('active', p.id === ('tab-' + tabName)));
  }));

  // ----------------- Save (UPDATE) button -----------------
  saveBtn.addEventListener('click', async () => {
    if (!filteredPatients || !filteredPatients.length) {
      alert("No patient selected to update.");
      return;
    }

    // Send only selected patient rows
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'updatePatient', data: filteredPatients })
      });
      const json = await res.json();
      if (json && json.result === 'success') {
        showToast(json.message || 'Updated successfully');
        // reload all rows to reflect any sheet-side changes
        await loadAllPatients();
        // reselect the same patient to refresh UI
        const key = currentPatientKey;
        if (key) {
          const first = allPatients.find(r => (safeLower(r.patientName) + '||' + safeLower(r.opdNo)) === key);
          if (first) selectPatient(first);
        }
      } else {
        showToast(json.message || 'Update completed');
      }
    } catch (err) {
      console.error('Update failed', err);
      alert('Update failed: ' + (err.message || 'network error'));
    }
  });

  // Cancel / Close â€” hide card and clear selection
  cancelBtn.addEventListener('click', () => {
    cardEl.style.display = 'none';
    filteredPatients = [];
    currentPatientKey = null;
    searchEl.value = '';
  });

  // ----------------- Accessibility: Enter key on search picks first suggestion -----------------
  searchEl.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      const first = suggEl.querySelector('.pp-suggestion');
      if (first) first.click();
    }
  });

  // ----------------- Initial focus -----------------
  // (optional) searchEl.focus();

  </script>
</body>
</html>
