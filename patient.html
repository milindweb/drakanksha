<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Profile Viewer</title>

  <!-- Global Header & Footer Loader -->
  <link rel="stylesheet" href="css/headerfooter.css">
  <script src="js/headerfooter.js" defer></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f1f5f9;
      margin: 0;
      padding: 0;
    }

    h2.page-title {
      text-align: center;
      margin-top: 20px;
      font-size: 1.6rem;
      color: #0f172a;
    }

    .search-box {
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 90%;
      max-width: 500px;
    }
    .search-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      outline: none;
    }
    .suggestions {
      width: 100%;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .suggestion-item:hover {
      background: #f9fafb;
    }

    .profile-card {
      background: white;
      width: 90%;
      max-width: 900px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      margin: 30px auto 50px;
      overflow: hidden;
      display: none;
      transition: 0.3s ease-in-out;
    }

    .profile-header {
      display: flex;
      align-items: center;
      background: #e2e8f0;
      padding: 20px;
    }
    .profile-header img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin-right: 20px;
      border: 3px solid #334155;
    }
    .profile-header h2 {
      margin: 0;
      color: #1e293b;
    }
    .profile-header p {
      color: #475569;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95em;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
    }
    th {
      background: #f8fafc;
    }
    td[contenteditable="true"] {
      background: #fff8dc;
    }

    .edit-icon {
      cursor: pointer;
      color: #2563eb;
      margin-left: 8px;
      font-size: 14px;
    }

    .update-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1em;
      margin: 15px;
      cursor: pointer;
      transition: 0.3s;
    }
    .update-btn:hover {
      background: #1d4ed8;
    }

    .success-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #22c55e;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.4s ease;
      font-size: 0.95em;
      z-index: 999;
    }
    .success-popup.show {
      opacity: 1;
      transform: translateY(0);
    }

    @media (max-width: 600px) {
      .profile-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .profile-header img {
        margin-bottom: 10px;
      }
    }
  </style>
</head>

<body>

  <!-- DYNAMIC HEADER -->
  <div id="header"></div>

  <h2 class="page-title">üîç Patient Profile Viewer</h2>

  <!-- Search Section -->
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search by Name, OPD No, or Mobile..." autocomplete="off" />
    <div class="suggestions" id="suggestions"></div>
  </div>

  <!-- Profile Section -->
  <div class="profile-card" id="profileCard">
    <div class="profile-header">
      <img src="https://i.ibb.co/sK7PjGf/profile-avatar.png" alt="Profile">
      <div>
        <h2 id="patientName"></h2>
        <p><strong>OPD No:</strong> <span id="opdNo"></span> |
           <strong>Mobile:</strong> <span id="mobileNo"></span></p>
      </div>
    </div>

    <div class="profile-body">
      <table id="patientTable">
        <thead>
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <center><button class="update-btn" id="updateBtn">UPDATE</button></center>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="success-popup" id="successPopup">Updated!</div>

  <!-- Footer -->
  <div id="footer"></div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwgRNLtac8jSFw8a9DTAwHaHMx8kgu4Ba7JhpTUgee1WfOK00zYIJ-zQIgG0TY1UuY37A/exec";

    let allPatients = [];
    let filteredPatients = [];

    async function fetchAllPatients() {
      const res = await fetch(scriptURL + "?action=read");
      allPatients = await res.json();
    }
    fetchAllPatients();

    const searchInput = document.getElementById("searchInput");
    const suggestions = document.getElementById("suggestions");

    searchInput.addEventListener("input", () => {
      const query = searchInput.value.trim().toLowerCase();
      if (!query) return suggestions.style.display = "none";

      const matches = allPatients.filter(p =>
        (p.patientName && p.patientName.toLowerCase().includes(query)) ||
        (p.opdNo && p.opdNo.toLowerCase().includes(query)) ||
        (p.mobileNo && p.mobileNo.toLowerCase().includes(query))
      );

      suggestions.innerHTML = "";
      if (matches.length === 0) return suggestions.style.display = "none";

      suggestions.style.display = "block";

      matches.slice(0, 10).forEach(p => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = `${p.patientName} (${p.opdNo || "No OPD"})`;

        div.addEventListener("click", () => showPatientProfile(p));
        suggestions.appendChild(div);
      });
    });

    function showPatientProfile(selected) {
      filteredPatients = allPatients.filter(p =>
        p.patientName.toLowerCase() === selected.patientName.toLowerCase()
      );

      suggestions.style.display = "none";
      searchInput.value = selected.patientName;

      const card = document.getElementById("profileCard");
      card.style.display = "block";

      document.getElementById("patientName").textContent = selected.patientName;
      document.getElementById("opdNo").textContent = selected.opdNo || "";
      document.getElementById("mobileNo").textContent = selected.mobileNo || "";

      const keys = Object.keys(selected);
      tableHeader.innerHTML = "";
      tableBody.innerHTML = "";

      keys.forEach(k => {
        const th = document.createElement("th");
        th.textContent = k;
        tableHeader.appendChild(th);
      });

      filteredPatients.forEach((r, rowIndex) => {
        const tr = document.createElement("tr");

        keys.forEach(k => {
          const td = document.createElement("td");
          td.textContent = r[k];

          td.addEventListener("dblclick", () => makeEditable(td, k, rowIndex));

          const edit = document.createElement("span");
          edit.innerHTML = "‚úèÔ∏è";
          edit.className = "edit-icon";
          edit.addEventListener("click", () => makeEditable(td, k, rowIndex));

          td.appendChild(edit);
          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });
    }

    function makeEditable(td, key, rowIndex) {
      td.contentEditable = true;
      td.focus();
      td.style.background = "#fff8dc";

      td.addEventListener("blur", () => {
        td.contentEditable = false;
        td.style.background = "";
        filteredPatients[rowIndex][key] = td.childNodes[0].nodeValue.trim();
      }, { once: true });
    }

    document.getElementById("updateBtn").addEventListener("click", async () => {
      if (filteredPatients.length === 0) return alert("No patient selected!");

      const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
          action: "updatePatient",
          data: filteredPatients
        }),
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();
      showPopup(result.message || "Updated!");
    });

    function showPopup(msg) {
      const popup = document.getElementById("successPopup");
      popup.textContent = msg;
      popup.classList.add("show");
      setTimeout(() => popup.classList.remove("show"), 3000);
    }
  </script>

</body>
</html>
